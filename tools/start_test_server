#!/usr/bin/env python3

import io
import socket
import sys
from http.server import SimpleHTTPRequestHandler, ThreadingHTTPServer
from pathlib import Path
from urllib.parse import urlparse

ORIGIN_DIR = Path(__file__).resolve().parent.parent
PORT = 8000

SW_PATH = "/pyxel-sw.js"
SW_JS = r"""// Pyxel test server service worker
self.addEventListener('install', (event) => {
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  event.waitUntil(self.clients.claim());
});

self.addEventListener('fetch', (event) => {
  const url = new URL(event.request.url);
  if (url.origin === 'https://cdn.jsdelivr.net' && url.pathname.startsWith('/gh/kitao/pyxel/wasm/')) {
    const suffix = url.pathname.replace('/gh/kitao/pyxel/wasm/', '');
    const localUrl = '/wasm/' + suffix;
    event.respondWith(fetch(localUrl, { cache: 'no-store' }));
    return;
  }
});
"""

INJECT_SNIPPET = (
    """
<script>
(function() {
  try {
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const isSecure = window.isSecureContext || isLocalhost;
    if (!isSecure || !('serviceWorker' in navigator)) return;
    navigator.serviceWorker.register('%s', { scope: '/' });
  } catch (e) {
    console.warn('SW register failed', e);
  }
})();
</script>
"""
    % SW_PATH
)


def _get_ip() -> str:
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as sock:
            sock.connect(("8.8.8.8", 80))
            return sock.getsockname()[0]
    except OSError:
        return "127.0.0.1"


class Handler(SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=str(ORIGIN_DIR), **kwargs)

    def do_GET(self):
        if self.path == SW_PATH:
            self.send_response(200)
            self.send_header("Content-Type", "application/javascript; charset=utf-8")
            self.send_header("Cache-Control", "no-store")
            self.end_headers()
            self.wfile.write(SW_JS.encode("utf-8"))
            return
        return super().do_GET()

    def send_head(self):
        parsed = urlparse(self.path)
        path = parsed.path
        if path.endswith(".html"):
            full_path = Path(self.translate_path(path))
            if not full_path.is_file():
                return super().send_head()
            try:
                data = full_path.read_bytes()
                text = data.decode("utf-8")
            except (OSError, UnicodeDecodeError):
                return super().send_head()

            injected = _inject_html(text)
            encoded = injected.encode("utf-8")

            self.send_response(200)
            self.send_header("Content-Type", "text/html; charset=utf-8")
            self.send_header("Content-Length", str(len(encoded)))
            self.end_headers()
            return io.BytesIO(encoded)

        return super().send_head()


def _inject_html(text: str) -> str:
    lower = text.lower()
    if "serviceworker" in lower or "service-worker" in lower:
        return text
    head_idx = lower.rfind("</head>")
    if head_idx != -1:
        return text[:head_idx] + INJECT_SNIPPET + text[head_idx:]
    body_idx = lower.rfind("</body>")
    if body_idx != -1:
        return text[:body_idx] + INJECT_SNIPPET + text[body_idx:]
    return text + INJECT_SNIPPET


def main() -> int:
    ip = _get_ip()
    print(f"Serving HTTP on {ip} port {PORT} (http://{ip}:{PORT}/) ...")
    server = ThreadingHTTPServer(("", PORT), Handler)
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        pass
    return 0


if __name__ == "__main__":
    sys.exit(main())
