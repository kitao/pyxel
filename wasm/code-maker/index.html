<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pyxel Code Maker</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>

    <!-- Ace Editor (+ language tools for autocompletion) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-language_tools.min.js"></script>

    <!-- Pyxel (Pyodide/WASM runtime helper) -->
    <script src="https://cdn.jsdelivr.net/gh/kitao/pyxel@2.5.9/wasm/pyxel.js"></script>
    <!-- JSZip (for Load/Save as .zip) -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style type="text/tailwindcss">
      @layer components {
        .page {
          @apply bg-gray-900 text-gray-100 antialiased;
        }
        .toolbar {
          @apply flex items-center gap-2 bg-gray-900 px-4 py-3 border-gray-700 border-b;
        }
        .btn {
          @apply bg-gray-700 hover:bg-gray-600 px-2 py-1 border border-gray-600 rounded-md min-w-[3.5rem] font-medium text-gray-300 text-xs text-center;
        }
        .btn-primary {
          @apply bg-indigo-600 hover:bg-indigo-500 border-indigo-500;
        }
        .btn.disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .tool-title {
          @apply mr-2 font-semibold text-gray-200 text-2xl tracking-tight select-none;
        }
        .seg {
          @apply flex items-center bg-gray-900 border border-gray-600 rounded-lg divide-x divide-gray-700 overflow-hidden;
        }
        .seg-btn {
          @apply flex-1 bg-gray-900 px-3 py-1 border-none focus:outline-none min-w-[2rem] font-medium text-gray-300 text-xs text-center;
        }
        .seg-active {
          @apply bg-slate-600 text-white;
        }
      }
    </style>
    <style>
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>

  <body class="h-full page">
    <div id="mainSplit" class="flex h-full min-h-0">
      <!-- LEFT SIDE (menu + editor/resource) -->
      <div
        id="leftPane"
        class="flex flex-col min-h-0"
        style="width: 50%; min-width: 200px; max-width: 80%"
      >
        <!-- Toolbar: Title / Import / Export / [Code | Res] / Run -->
        <div class="toolbar">
          <div class="tool-title">Pyxel Code Maker</div>
          <!-- Control groups wrapper (takes remaining horizontal space, right-aligned) -->
          <div class="flex flex-1 justify-end items-center min-w-0">
            <!-- Left group: Import / Export -->
            <div class="flex items-center gap-2">
              <button id="importBtn" class="btn" title="Import project (.zip)">
                Import
              </button>
              <button id="exportBtn" class="btn" title="Export project (.zip)">
                Export
              </button>
            </div>
            <!-- Center group: Code / Res (no explicit center) -->
            <div class="flex items-center px-4">
              <div class="seg" role="group" aria-label="Edit target">
                <button
                  id="codeTabBtn"
                  class="seg-btn seg-active"
                  type="button"
                  aria-pressed="true"
                  title="Edit Python code"
                >
                  Code
                </button>
                <button
                  id="resTabBtn"
                  class="seg-btn"
                  type="button"
                  aria-pressed="false"
                  title="Edit Pyxel resources"
                >
                  Res
                </button>
              </div>
            </div>
            <!-- Right group: Run -->
            <div class="flex items-center gap-2">
              <button
                id="runBtn"
                class="btn disabled"
                disabled
                title="Run (Ctrl/⌘+Enter)"
              >
                Run
              </button>
            </div>
          </div>
        </div>

        <!-- Code pane -->
        <div id="codePane" class="flex flex-1 min-h-0">
          <div id="editor" class="w-full h-full"></div>
        </div>

        <!-- Resource pane -->
        <div id="resPane" class="hidden flex-1 min-h-0">
          <iframe
            id="pyxelEditorFrame"
            class="border-0 w-full h-full"
            title="Pyxel Resource Editor"
          ></iframe>
        </div>
      </div>

      <!-- Divider: draggable vertical bar (thicker, no gap) -->
      <div
        id="dividerHit"
        class="w-2 cursor-col-resize"
        style="background-color: #232d3b"
        onpointerenter="this.style.backgroundColor='#3a4a5f'"
        onpointerleave="this.style.backgroundColor='#232d3b'"
        title="Drag to resize"
      ></div>

      <!-- RIGHT SIDE (preview only) -->
      <div
        class="flex flex-col flex-1 min-h-0"
        style="background-color: var(--pyxel-background-color)"
      >
        <iframe
          id="pyxelScreenFrame"
          class="flex-1 border-0 w-full h-full min-h-0"
          style="background-color: var(--pyxel-background-color)"
          title="Pyxel Runtime"
        ></iframe>
      </div>
    </div>

    <input
      id="loadFileInput"
      type="file"
      accept=".zip,application/zip"
      class="hidden"
    />
    <input
      id="importFileInput"
      type="file"
      accept=".zip,application/zip"
      class="hidden"
    />

    <script>
      const MIN_LEFT_PANE_WIDTH = 550;

      const project = new Map();
      let mainPyPath = "main.py";
      let resPath = null;
      let currentMode = "code";

      // -------------------------------------------------
      // Utility functions
      // -------------------------------------------------
      function uint8ToBase64(u8) {
        let bin = "";
        for (let i = 0; i < u8.length; i++) {
          bin += String.fromCharCode(u8[i]);
        }
        return btoa(bin);
      }

      function base64ToUint8(b64) {
        const bin = atob(b64 || "");
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) {
          bytes[i] = bin.charCodeAt(i);
        }
        return bytes;
      }

      function resolvePyxelInput() {
        if (pyxelScreenFrame?.contentWindow?.pyxelContext?.resolveInput) {
          pyxelScreenFrame.contentWindow.pyxelContext.resolveInput();
        }

        if (pyxelEditorFrame?.contentWindow?.pyxelContext?.resolveInput) {
          pyxelEditorFrame.contentWindow.pyxelContext.resolveInput();
        }
      }

      async function loadInitialFiles() {
        const pyCode = await (await fetch("main.py")).text();
        project.set(mainPyPath, {
          kind: "file",
          content: pyCode,
        });

        const u8 = new Uint8Array(
          await (await fetch("my_resource.pyxres")).arrayBuffer()
        );
        resPath = "my_resource.pyxres";
        project.set(resPath, {
          kind: "file",
          content: uint8ToBase64(u8),
        });
      }

      function initializeIframes() {
        return new Promise((resolve) => {
          let editorLoaded = false;
          let runtimeLoaded = false;

          const checkBothLoaded = () => {
            if (editorLoaded && runtimeLoaded) {
              resolve();
            }
          };

          pyxelEditorFrame.onload = () => {
            editorLoaded = true;
            checkBothLoaded();
          };

          pyxelScreenFrame.onload = () => {
            runtimeLoaded = true;
            checkBothLoaded();
          };

          // HTMLを設定
          pyxelEditorFrame.src = "./pyxel-editor.html";
          pyxelScreenFrame.src = "./pyxel-screen.html";
        });
      }

      // -------------------------------------------------
      // ステップ3: JSの処理を開始
      // -------------------------------------------------
      async function initializeApp() {
        await loadInitialFiles();
        await initializeIframes();
        switchPane();
        watchPyxelInputWait();
        editor.focus();
      }

      // -------------------------------------------------
      // Ace Editor setup
      // -------------------------------------------------
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/python");

      editor.renderer.setScrollMargin(8, 0, 0, 0);
      editor.renderer.setPadding(8);

      editor.setOptions({
        fontSize: "14px",
        showPrintMargin: false,
        highlightActiveLine: true,
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
        enableSnippets: true,
      });

      editor.container.style.backgroundColor = "#111827";

      const gutter = editor.renderer.$gutter;
      if (gutter && gutter.style) {
        gutter.style.background = "#232d3b";
      }

      const aceThemeStyle = document.createElement("style");
      aceThemeStyle.textContent = `
        .ace-monokai .ace_marker-layer .ace_active-line,
        .ace_monokai .ace_marker-layer .ace_active-line {
          background-color: #232d3b !important;
        }

        .ace-monokai .ace_gutter-active-line,
        .ace_monokai .ace_gutter-active-line {
          background-color: #374151 !important;
        }
      `;
      document.head.appendChild(aceThemeStyle);

      // -------------------------------------------------
      // Completions
      // -------------------------------------------------
      let completions = [];

      fetch("./completions.txt")
        .then((res) => res.text())
        .then((text) => {
          completions = text
            .trim()
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line && !line.startsWith("#"));
          console.log("Loaded", completions.length, "completions");
        })
        .catch((err) => console.warn("Failed to load completions:", err));

      const pyxelCompleter = {
        getCompletions(editor, session, pos, prefix, callback) {
          callback(
            null,
            completions.map((w) => ({ caption: w, value: w, meta: "pyxel" }))
          );
        },
      };
      ace.require("ace/ext/language_tools").addCompleter(pyxelCompleter);

      // -------------------------------------------------
      // DOM elements
      // -------------------------------------------------
      const codePane = document.getElementById("codePane");
      const resPane = document.getElementById("resPane");
      const codeTabBtn = document.getElementById("codeTabBtn");
      const resTabBtn = document.getElementById("resTabBtn");

      const pyxelScreenFrame = document.getElementById("pyxelScreenFrame");
      const pyxelEditorFrame = document.getElementById("pyxelEditorFrame");

      const loadFileInput = document.getElementById("loadFileInput");
      const importFileInput = document.getElementById("importFileInput");

      // -------------------------------------------------
      // Split resize (drag center divider)
      // -------------------------------------------------
      const mainSplit = document.getElementById("mainSplit");
      const leftPaneEl = document.getElementById("leftPane");
      const dividerHitEl = document.getElementById("dividerHit");

      if (dividerHitEl && leftPaneEl && mainSplit) {
        let startPointerId = null;
        let startX = 0;
        let startWidth = 0;
        let minAllowedWidth = 200;

        const onPointerMove = (e) => {
          if (startPointerId === null) return;

          const dx = e.clientX - startX;
          let newW = startWidth + dx;

          const containerW = mainSplit.getBoundingClientRect().width;
          const maxW = containerW * 0.8;

          if (newW < minAllowedWidth) newW = minAllowedWidth;
          if (newW > maxW) newW = maxW;

          leftPaneEl.style.width = newW + "px";
          editor.resize();
        };

        const endDrag = () => {
          if (startPointerId !== null) {
            const id = startPointerId;
            startPointerId = null;
            document.body.style.cursor = "";
            dividerHitEl.releasePointerCapture(id);
            pyxelScreenFrame.style.visibility = "visible"; // ドラッグ終了時にiframeを表示に戻す
          }
        };

        dividerHitEl.addEventListener("pointerdown", (e) => {
          startPointerId = e.pointerId;
          startX = e.clientX;
          startWidth = leftPaneEl.getBoundingClientRect().width;

          minAllowedWidth = MIN_LEFT_PANE_WIDTH;

          document.body.style.cursor = "col-resize";
          dividerHitEl.setPointerCapture(e.pointerId);
          pyxelScreenFrame.style.visibility = "hidden"; // ドラッグ開始時にiframeを隠す
          e.preventDefault();
        });

        dividerHitEl.addEventListener("pointermove", onPointerMove);
        dividerHitEl.addEventListener("pointerup", endDrag);
        dividerHitEl.addEventListener("pointercancel", endDrag);
      }

      // -------------------------------------------------
      // Pane switching functions
      // -------------------------------------------------
      function switchPane() {
        if (currentMode === "code") {
          codePane.classList.remove("hidden");
          resPane.classList.add("hidden");

          codeTabBtn.classList.add("seg-active");
          resTabBtn.classList.remove("seg-active");
          codeTabBtn.setAttribute("aria-pressed", "true");
          resTabBtn.setAttribute("aria-pressed", "false");

          const meta = project.get(mainPyPath);
          editor.setValue(meta?.content ?? "", -1);
          setTimeout(() => editor.resize(), 0);
        } else {
          codePane.classList.add("hidden");
          resPane.classList.remove("hidden");

          codeTabBtn.classList.remove("seg-active");
          resTabBtn.classList.add("seg-active");
          codeTabBtn.setAttribute("aria-pressed", "false");
          resTabBtn.setAttribute("aria-pressed", "true");

          if (resPath) {
            const meta = project.get(resPath);
            if (meta) {
              const payload = {
                type: "open",
                path: resPath,
                base64: meta.content || "",
              };
              const f = pyxelEditorFrame;
              const post = () => {
                try {
                  f.contentWindow?.postMessage(payload, "*");
                } catch (e) {
                  console.warn(e);
                }
              };
              if (f.contentWindow) post();
              else f.onload = post;
            }
          }
        }
      }

      async function saveCurrentToMemory() {
        if (currentMode === "code") {
          const meta = project.get(mainPyPath);
          if (meta) {
            meta.content = editor.getValue();
            project.set(mainPyPath, meta);
          }
        } else if (currentMode === "res") {
          // In future: receive updated .pyxres data from pyxelEditorFrame via postMessage
        }
      }

      // -------------------------------------------------
      // Project operations
      // -------------------------------------------------
      function getActiveCode() {
        if (mainPyPath && project.has(mainPyPath)) {
          const meta = project.get(mainPyPath);
          return meta?.content ?? editor.getValue();
        }
        return editor.getValue();
      }

      function getResourceBase64() {
        if (resPath && project.has(resPath)) {
          return project.get(resPath).content || "";
        }
        return "";
      }

      async function runApp() {
        await saveCurrentToMemory();

        const payload = {
          type: "run",
          code: getActiveCode(),
          res: getResourceBase64(),
        };

        try {
          if (pyxelScreenFrame && pyxelScreenFrame.contentWindow) {
            pyxelScreenFrame.contentWindow.postMessage(payload, "*");
          } else {
            console.warn("pyxelScreenFrame is not ready");
          }
        } catch (e) {
          console.error("Failed to post code to pyxelScreenFrame:", e);
        }
      }

      function triggerLoadZip() {
        if (loadFileInput) {
          loadFileInput.value = "";
          loadFileInput.click();
        }
      }

      function triggerImportZip() {
        if (importFileInput) {
          importFileInput.value = "";
          importFileInput.click();
        }
      }

      async function handleZipFile(file) {
        if (!file) return;
        try {
          project.clear();
          mainPyPath = "main.py";
          resPath = null;

          const buf = await file.arrayBuffer();
          const zip = await JSZip.loadAsync(buf);

          let pyCode = null;
          let foundResName = null;
          let foundResB64 = null;

          const entries = Object.entries(zip.files);
          for (const [path, entry] of entries) {
            if (entry.dir) continue;

            if (path.endsWith("main.py")) {
              pyCode = await entry.async("string");
            } else if (path.toLowerCase().endsWith(".pyxres") && !foundResB64) {
              const u8 = await entry.async("uint8array");
              foundResB64 = uint8ToBase64(u8);
              foundResName = path;
            }
          }

          if (pyCode == null) {
            throw new Error("main.py not found in zip file");
          }

          project.set(mainPyPath, {
            kind: "file",
            content: pyCode,
          });

          if (foundResB64) {
            resPath = foundResName;
            project.set(resPath, {
              kind: "file",
              content: foundResB64,
            });
          }

          switchPane();
        } catch (e) {
          console.warn("Failed to load zip:", e);
          alert("Failed to import project: " + e.message);
        }
      }

      async function exportAsZip() {
        await saveCurrentToMemory();

        const zip = new JSZip();

        const mainMeta = project.get(mainPyPath);
        if (mainMeta && mainMeta.content != null) {
          zip.file(mainPyPath, mainMeta.content);
        }

        if (resPath) {
          const resMeta = project.get(resPath);
          if (resMeta && resMeta.content != null) {
            const bytes = base64ToUint8(resMeta.content);
            zip.file(resPath, bytes);
          }
        }

        const blob = await zip.generateAsync({ type: "blob" });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "pyxel-project.zip";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }

      // -------------------------------------------------
      // Runボタン有効化の監視
      // -------------------------------------------------
      function watchPyxelInputWait() {
        const pyxelScreenReady =
          pyxelScreenFrame?.contentWindow?.pyxelContext?.resolveInput;
        const pyxelEditorReady =
          pyxelEditorFrame?.contentWindow?.pyxelContext?.resolveInput;

        if (pyxelScreenReady && pyxelEditorReady) {
          const runBtn = document.getElementById("runBtn");
          if (runBtn) {
            runBtn.disabled = false;
            runBtn.classList.remove("disabled");
          }
        } else {
          setTimeout(watchPyxelInputWait, 100);
        }
      }

      // -------------------------------------------------
      // Event listeners registration
      // -------------------------------------------------
      codeTabBtn.addEventListener("click", () => {
        currentMode = "code";
        switchPane();
      });

      resTabBtn.addEventListener("click", () => {
        currentMode = "res";
        switchPane();
      });

      document
        .getElementById("loadBtn")
        ?.addEventListener("click", triggerLoadZip);

      document
        .getElementById("importBtn")
        ?.addEventListener("click", triggerImportZip);

      document
        .getElementById("exportBtn")
        ?.addEventListener("click", exportAsZip);

      document.getElementById("runBtn")?.addEventListener("click", runApp);

      if (importFileInput) {
        importFileInput.addEventListener("change", async (e) => {
          const file = e.target.files && e.target.files[0];
          await handleZipFile(file);
        });
      }

      // -------------------------------------------------
      // DOMContentLoaded: アプリ初期化を開始
      // -------------------------------------------------
      window.addEventListener("DOMContentLoaded", () => {
        window.addEventListener("click", () => {
          resolvePyxelInput();
        });

        window.addEventListener("touchstart", () => {
          resolvePyxelInput();
        });

        window.addEventListener("keydown", (e) => {
          resolvePyxelInput();
        });

        initializeApp();
      });
    </script>
  </body>
</html>
