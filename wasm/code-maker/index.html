<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pyxel Code Maker</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-language_tools.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kitao/pyxel@2.5.9/wasm/pyxel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style type="text/tailwindcss">
      @layer components {
        .page {
          @apply bg-gray-900 text-gray-100 antialiased;
        }
        .toolbar {
          @apply flex items-center gap-2 bg-gray-900 px-4 py-3 border-gray-700 border-b;
        }
        .btn {
          @apply bg-gray-900 px-2 py-1 border border-gray-600 rounded-md min-w-[3.5rem] font-medium text-gray-300 text-xs text-center;
        }
        .btn-primary {
          @apply bg-indigo-600 hover:bg-indigo-500 border-indigo-500;
        }
        .btn.disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .btn:disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .btn.active {
          @apply bg-slate-600 text-white;
        }
        .tool-title {
          @apply mr-2 font-semibold text-gray-200 text-2xl tracking-tight select-none;
        }
        .tool-tagline {
          @apply text-gray-300 text-sm leading-5 whitespace-nowrap select-none;
        }
        .link {
          @apply text-indigo-400 hover:text-indigo-300 visited:text-indigo-400 underline underline-offset-2;
        }
        .seg {
          @apply flex items-center bg-gray-900 border border-gray-600 rounded-md divide-x divide-gray-700 overflow-hidden;
        }
        .seg-btn {
          @apply flex-1 bg-gray-900 px-3 py-1 border-none focus:outline-none min-w-[2rem] font-medium text-gray-300 text-xs text-center;
        }
        .seg-btn.disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .seg-active {
          @apply bg-slate-600 text-white;
        }
      }
    </style>
    <style>
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* When resource pane is active, match right-side background */
      #left-pane.res-mode {
        background-color: var(--pyxel-background-color);
      }
    </style>
  </head>

  <body class="h-full page">
    <div id="app-root" class="flex flex-col h-full min-h-0">
      <!-- FULL-WIDTH TOOLBAR (spans from left edge to right edge) -->
      <div
        class="flex items-center gap-4 bg-gray-900 px-4 py-3 border-gray-700 border-b toolbar"
      >
        <div class="flex items-baseline gap-2 min-w-0">
          <div class="tool-title">Pyxel Code Maker</div>
          <div class="truncate tool-tagline">
            Playground for
            <a class="link" href="https://github.com/kitao/pyxel">Pyxel</a>, a
            retro game engine for Python.
          </div>
        </div>
        <!-- Control groups wrapper (takes remaining horizontal space, right-aligned) -->
        <div class="flex flex-1 justify-start items-center mt-0.5 min-w-0">
          <!-- Left group: Import / Export -->
          <div class="flex items-center gap-2">
            <button id="import-btn" class="btn" title="Import project (.zip)">
              Import
            </button>
            <button id="export-btn" class="btn" title="Export project (.zip)">
              Export
            </button>
          </div>
          <!-- Center group: Code / Res (no explicit center) -->
          <div class="flex items-center px-4">
            <div class="seg" role="group" aria-label="Edit target">
              <button
                id="code-tab-btn"
                class="seg-btn seg-active"
                type="button"
                aria-pressed="true"
                title="Edit Python code"
              >
                Code
              </button>
              <button
                id="res-tab-btn"
                class="seg-btn disabled"
                type="button"
                aria-pressed="false"
                title="Edit Pyxel resources"
              >
                Res
              </button>
            </div>
          </div>
          <!-- Right group: Run -->
          <div class="flex items-center gap-2">
            <button
              id="run-btn"
              class="btn"
              disabled
              title="Run (Ctrl/⌘+Enter)"
            >
              Run
            </button>
          </div>
        </div>
      </div>

      <!-- CONTENT AREA BELOW TOOLBAR: LEFT/RIGHT SPLIT -->
      <div id="main-split" class="flex flex-1 min-h-0">
        <!-- LEFT SIDE (editor/resource panes only) -->
        <div
          id="left-pane"
          class="flex flex-col min-h-0"
          style="width: 50%; min-width: 200px; max-width: 80%"
        >
          <!-- Code pane -->
          <div id="code-pane" class="flex flex-1 min-h-0">
            <div id="editor" class="w-full h-full"></div>
          </div>

          <!-- Resource pane -->
          <div id="res-pane" class="hidden flex flex-1 min-h-0">
            <iframe
              id="pyxel-editor-iframe"
              class="border-0 w-full h-full"
              style="background-color: var(--pyxel-background-color)"
              title="Pyxel Resource Editor"
            ></iframe>
          </div>
        </div>

        <!-- Divider: draggable vertical bar (thicker, no gap) -->
        <div
          id="divider-hit"
          class="z-50 relative w-2.5 cursor-col-resize select-none"
          style="
            background-color: #000000;
            touch-action: none;
            pointer-events: none;
          "
          onpointerenter="this.style.backgroundColor='#3a4a5f'"
          onpointerleave="this.style.backgroundColor='#232d3b'"
          title="Drag to resize"
        ></div>

        <!-- RIGHT SIDE (preview only) -->
        <div
          class="flex flex-col flex-1 min-h-0"
          style="background-color: var(--pyxel-background-color)"
        >
          <iframe
            id="pyxel-screen-iframe"
            class="flex-1 border-0 w-full h-full min-h-0"
            style="background-color: var(--pyxel-background-color)"
            title="Pyxel Runtime"
          ></iframe>
        </div>
      </div>
    </div>

    <input
      id="load-file-input"
      type="file"
      accept=".zip,application/zip"
      class="hidden"
    />
    <input
      id="import-file-input"
      type="file"
      accept=".zip,application/zip"
      class="hidden"
    />

    <script>
      const pyxelScreenIframe = document.getElementById("pyxel-screen-iframe");
      const pyxelEditorIframe = document.getElementById("pyxel-editor-iframe");

      let projectFileName = "pyxel-project.zip";

      function uint8ToBase64(u8) {
        let bin = "";
        for (let i = 0; i < u8.length; i++) {
          bin += String.fromCharCode(u8[i]);
        }
        return btoa(bin);
      }

      function base64ToUint8(b64) {
        const bin = atob(b64 || "");
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) {
          bytes[i] = bin.charCodeAt(i);
        }
        return bytes;
      }

      function animateButton(btn) {
        btn.classList.add("active");
        setTimeout(() => btn.classList.remove("active"), 150);
      }

      function copyEditorCodeToWindow() {
        window.code = editor.getValue();
      }

      async function copyIframeResToWindow() {
        if (!pyxelEditorIframe.contentWindow) {
          return;
        }

        const doc = pyxelEditorIframe.contentWindow.document;
        doc.dispatchEvent(
          new KeyboardEvent("keydown", {
            key: "Control",
            code: "ControlLeft",
            ctrlKey: true,
            bubbles: true,
          })
        );
        doc.dispatchEvent(
          new KeyboardEvent("keydown", {
            key: "s",
            code: "KeyS",
            ctrlKey: true,
            bubbles: true,
          })
        );
        doc.dispatchEvent(
          new KeyboardEvent("keyup", {
            key: "s",
            code: "KeyS",
            ctrlKey: true,
            bubbles: true,
          })
        );
        doc.dispatchEvent(
          new KeyboardEvent("keyup", {
            key: "Control",
            code: "ControlLeft",
            ctrlKey: false,
            bubbles: true,
          })
        );

        await new Promise((resolve) => setTimeout(resolve, 100));

        window.res = uint8ToBase64(
          pyxelEditorIframe.contentWindow.pyxelContext.pyodide.FS.readFile(
            PYXEL_WORKING_DIRECTORY + "/my_resource.pyxres"
          )
        );
      }

      function resetPyxelScreen() {
        if (pyxelScreenIframe.contentWindow != null) {
          pyxelScreenIframe.contentWindow.resetPyxel();
        }
      }

      function resetPyxelEditor() {
        if (pyxelEditorIframe.contentWindow != null) {
          pyxelEditorIframe.contentWindow.resetPyxel();
        }
      }

      async function importProject(file) {
        if (!file) {
          return;
        }
        try {
          const buf = await file.arrayBuffer();
          const zip = await JSZip.loadAsync(buf);

          let pyCode = null;
          let foundResName = null;
          let foundResB64 = null;

          const entries = Object.entries(zip.files);
          for (const [path, entry] of entries) {
            if (entry.dir) {
              continue;
            }
            if (path.endsWith("main.py")) {
              pyCode = await entry.async("string");
            } else if (path.toLowerCase().endsWith(".pyxres") && !foundResB64) {
              const u8 = await entry.async("uint8array");
              foundResB64 = uint8ToBase64(u8);
              foundResName = path;
            }
          }

          if (pyCode == null) {
            throw new Error("main.py not found in zip file");
          }

          window.code = pyCode;
          editor.setValue(pyCode, -1);
          editor.focus();

          if (foundResB64) {
            window.res = foundResB64;
          }

          resetPyxelScreen();
          resetPyxelEditor();
        } catch (e) {
          console.warn("Failed to load zip:", e);
          alert("Failed to import project: " + e.message);
        }
      }

      async function exportProject() {
        copyEditorCodeToWindow();
        await copyIframeResToWindow();

        const zip = new JSZip();

        if (typeof window.code === "string") {
          zip.file("main.py", window.code);
        }
        if (typeof window.res === "string") {
          const bytes = base64ToUint8(window.res);
          const resName = "my_resource.pyxres";
          zip.file(resName, bytes);
        }

        const blob = await zip.generateAsync({ type: "blob" });

        if (window.showSaveFilePicker) {
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: projectFileName,
              types: [
                {
                  description: "ZIP",
                  accept: { "application/zip": [".zip"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            projectFileName = handle.name;
            return;
          } catch (e) {
            if (e.name === "AbortError") {
              return;
            }
            console.warn("save failed:", e);
          }
        }

        // フォールバック：従来のダウンロードリンク方式
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = projectFileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }

      function initAceEditor() {
        const editorInstance = ace.edit("editor");

        editorInstance.setTheme("ace/theme/monokai");
        editorInstance.session.setMode("ace/mode/python");
        editorInstance.renderer.setScrollMargin(8, 0, 0, 0);
        editorInstance.renderer.setPadding(8);

        editorInstance.setOptions({
          fontSize: "14px",
          showPrintMargin: false,
          highlightActiveLine: true,
          enableBasicAutocompletion: true,
          enableLiveAutocompletion: true,
        });

        editorInstance.container.style.backgroundColor = "#111827";

        const gutter = editorInstance.renderer.$gutter;
        if (gutter?.style) {
          gutter.style.background = "#232d3b";
        }

        const aceThemeStyle = document.createElement("style");
        aceThemeStyle.textContent = `
          .ace-monokai .ace_marker-layer .ace_active-line,
          .ace_monokai .ace_marker-layer .ace_active-line {
            background-color: #232d3b !important;
          }

          .ace-monokai .ace_gutter-active-line,
          .ace_monokai .ace_gutter-active-line {
            background-color: #374151 !important;
          }
        `;
        document.head.appendChild(aceThemeStyle);

        window.editor = editorInstance;
      }

      function setupButtonHandlers() {
        const importBtn = document.getElementById("import-btn");
        const exportBtn = document.getElementById("export-btn");
        const codeTabBtn = document.getElementById("code-tab-btn");
        const resTabBtn = document.getElementById("res-tab-btn");
        const codePane = document.getElementById("code-pane");
        const resPane = document.getElementById("res-pane");
        const leftPane = document.getElementById("left-pane");
        const runBtn = document.getElementById("run-btn");
        const importFileInput = document.getElementById("import-file-input");

        importBtn.addEventListener("click", async () => {
          animateButton(importBtn);
          importFileInput.value = "";
          importFileInput.click();
        });

        importFileInput.addEventListener("change", async (e) => {
          const file = e.target.files?.[0];
          if (file && file.name) projectFileName = file.name;
          importProject(file);
        });

        exportBtn.addEventListener("click", async () => {
          animateButton(exportBtn);
          await exportProject();
        });

        codeTabBtn.addEventListener("click", () => {
          codePane.classList.remove("hidden");
          resPane.classList.add("hidden");
          codeTabBtn.classList.add("seg-active");
          resTabBtn.classList.remove("seg-active");
          codeTabBtn.setAttribute("aria-pressed", "true");
          resTabBtn.setAttribute("aria-pressed", "false");
          leftPane.classList.remove("res-mode");
          setTimeout(() => editor.resize(), 0);
        });

        resTabBtn.addEventListener("click", () => {
          codePane.classList.add("hidden");
          resPane.classList.remove("hidden");
          codeTabBtn.classList.remove("seg-active");
          resTabBtn.classList.add("seg-active");
          codeTabBtn.setAttribute("aria-pressed", "false");
          resTabBtn.setAttribute("aria-pressed", "true");
          leftPane.classList.add("res-mode");
        });

        runBtn.addEventListener("click", async () => {
          animateButton(runBtn);
          copyEditorCodeToWindow();
          await copyIframeResToWindow();
          resetPyxelScreen();
        });
      }

      async function loadInitialFiles() {
        window.code = await (await fetch("main.py")).text();
        window.res = uint8ToBase64(
          new Uint8Array(
            await (await fetch("my_resource.pyxres")).arrayBuffer()
          )
        );

        editor.setValue(window.code, -1);
        editor.focus();

        if (window.res) {
        }
      }

      async function initIframes() {
        const screenLoaded = new Promise((resolve) => {
          pyxelScreenIframe.onload = () => resolve();
        });

        const editorLoaded = new Promise((resolve) => {
          pyxelEditorIframe.onload = () => resolve();
        });

        pyxelScreenIframe.src = "pyxel-screen.html";
        pyxelEditorIframe.src = "pyxel-editor.html";

        return Promise.all([screenLoaded, editorLoaded]);
      }

      function waitForPyxelReady() {
        if (
          pyxelScreenIframe?.contentWindow?.pyxelContext?.resolveInput &&
          pyxelEditorIframe?.contentWindow?.pyxelContext?.resolveInput
        ) {
          const runBtn = document.getElementById("run-btn");
          runBtn.disabled = false;

          const resTabBtn = document.getElementById("res-tab-btn");
          resTabBtn.disabled = false;
          resTabBtn.classList.remove("disabled");

          const dividerHitEl = document.getElementById("divider-hit");
          dividerHitEl.style.pointerEvents = "auto";
          dividerHitEl.style.backgroundColor = "#232d3b";
        } else {
          setTimeout(waitForPyxelReady, 100);
        }
      }

      function setupSplitter() {
        const mainSplit = document.getElementById("main-split");
        const leftPaneEl = document.getElementById("left-pane");
        const dividerHitEl = document.getElementById("divider-hit");

        let dragging = false;
        let startX = 0;
        let startWidth = 0;

        function onMove(e) {
          if (!dragging) {
            return;
          }
          const dx = e.clientX - startX;
          let newW = startWidth + dx;
          const containerW = mainSplit.getBoundingClientRect().width;
          const minW = Math.min(200, containerW / 2);
          const maxW = containerW - minW;
          newW = Math.max(minW, Math.min(maxW, newW));
          leftPaneEl.style.width = newW + "px";
          if (editor && editor.resize) {
            editor.resize();
          }
        }

        function onUp() {
          if (!dragging) {
            return;
          }
          dragging = false;
          window.removeEventListener("pointermove", onMove);
          window.removeEventListener("pointerup", onUp);
          window.removeEventListener("pointercancel", onUp);
          document.body.style.cursor = "";
          document.body.style.userSelect = "";
          pyxelScreenIframe.style.display = "";
          pyxelEditorIframe.style.display = "";
        }

        function onDown(e) {
          dragging = true;
          startX = e.clientX;
          startWidth = leftPaneEl.getBoundingClientRect().width;
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          pyxelScreenIframe.style.display = "none";
          pyxelEditorIframe.style.display = "none";
          window.addEventListener("pointermove", onMove);
          window.addEventListener("pointerup", onUp);
          window.addEventListener("pointercancel", onUp);
          e.preventDefault();
        }

        dividerHitEl.addEventListener("pointerdown", onDown);
      }

      function setupPyxelInput() {
        const handlers = ["click", "touchstart", "keydown"];
        function resolvePyxelInput() {
          if (pyxelScreenIframe?.contentWindow?.pyxelContext?.resolveInput) {
            pyxelScreenIframe.contentWindow.pyxelContext.resolveInput();
          }

          if (pyxelEditorIframe?.contentWindow?.pyxelContext?.resolveInput) {
            pyxelEditorIframe.contentWindow.pyxelContext.resolveInput();
          }
        }

        handlers.forEach((eventName) => {
          window.addEventListener(eventName, () => {
            resolvePyxelInput();
          });
        });
      }

      window.addEventListener("DOMContentLoaded", async () => {
        initAceEditor();
        setupButtonHandlers();
        await loadInitialFiles();
        await initIframes();
        waitForPyxelReady();
        setupSplitter();
        setupPyxelInput();
      });
    </script>
  </body>
</html>
