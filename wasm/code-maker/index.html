<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pyxel Code Maker</title>

    <script src="https://cdn.tailwindcss.com/3.4.17"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-language_tools.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/kitao/pyxel@2.5.9/wasm/pyxel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style type="text/tailwindcss">
      @layer components {
        .page {
          @apply bg-gray-900 text-gray-100 antialiased;
        }
        .toolbar {
          @apply flex items-center gap-2 bg-gray-900 px-4 py-3 border-gray-700 border-b;
        }
        .btn {
          @apply bg-gray-900 px-2 py-1 border border-gray-600 rounded-md min-w-[3.5rem] font-medium text-gray-300 text-xs text-center;
        }
        .btn-primary {
          @apply bg-indigo-600 hover:bg-indigo-500 border-indigo-500;
        }
        .btn.disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .btn:disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .btn.active {
          @apply bg-slate-600 text-white;
        }
        .tool-title {
          @apply mr-2 font-semibold text-gray-200 text-2xl tracking-tight select-none;
        }
        .tool-tagline {
          @apply text-gray-300 text-sm leading-5 whitespace-nowrap select-none;
        }
        .link {
          @apply text-indigo-400 hover:text-indigo-300 visited:text-indigo-400 underline underline-offset-2;
        }
        .seg {
          @apply flex items-center bg-gray-900 border border-gray-600 rounded-md divide-x divide-gray-700 overflow-hidden;
        }
        .seg-btn {
          @apply flex-1 bg-gray-900 px-3 py-1 border-none focus:outline-none min-w-[2rem] font-medium text-gray-300 text-xs text-center;
        }
        .seg-btn.disabled {
          @apply bg-gray-700 opacity-50 focus:border-gray-300 text-gray-400 pointer-events-none;
        }
        .seg-active {
          @apply bg-slate-600 text-white;
        }
      }
    </style>
    <style>
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* When resource pane is active, match right-side background */
      #left-pane.res-mode {
        background-color: var(--pyxel-background-color);
      }
    </style>
  </head>

  <body class="h-full page">
    <div id="app-root" class="flex flex-col h-full min-h-0">
      <!-- FULL-WIDTH TOOLBAR (spans from left edge to right edge) -->
      <div
        class="flex items-center gap-4 bg-gray-900 px-4 py-3 border-gray-700 border-b toolbar"
      >
        <div class="flex items-baseline gap-2 min-w-0">
          <div class="tool-title">Pyxel Code Maker</div>
          <div class="truncate tool-tagline">
            Playground for
            <a class="link" href="https://github.com/kitao/pyxel">Pyxel</a>, a
            retro game engine for Python.
          </div>
        </div>
        <!-- Control groups wrapper (takes remaining horizontal space, right-aligned) -->
        <div class="flex flex-1 justify-start items-center mt-0.5 min-w-0">
          <!-- Left group: Import / Export -->
          <div class="flex items-center gap-2">
            <button id="importBtn" class="btn" title="Import project (.zip)">
              Import
            </button>
            <button id="exportBtn" class="btn" title="Export project (.zip)">
              Export
            </button>
          </div>
          <!-- Center group: Code / Res (no explicit center) -->
          <div class="flex items-center px-4">
            <div class="seg" role="group" aria-label="Edit target">
              <button
                id="code-tab-btn"
                class="seg-btn seg-active"
                type="button"
                aria-pressed="true"
                title="Edit Python code"
              >
                Code
              </button>
              <button
                id="res-tab-btn"
                class="seg-btn disabled"
                type="button"
                aria-pressed="false"
                title="Edit Pyxel resources"
              >
                Res
              </button>
            </div>
          </div>
          <!-- Right group: Run -->
          <div class="flex items-center gap-2">
            <button
              id="runBtn"
              class="btn"
              disabled
              title="Run (Ctrl/⌘+Enter)"
              onmousedown="animateRunButton(this)"
            >
              Run
            </button>
          </div>
        </div>
      </div>

      <!-- CONTENT AREA BELOW TOOLBAR: LEFT/RIGHT SPLIT -->
      <div id="main-split" class="flex flex-1 min-h-0">
        <!-- LEFT SIDE (editor/resource panes only) -->
        <div
          id="left-pane"
          class="flex flex-col min-h-0"
          style="width: 50%; min-width: 200px; max-width: 80%"
        >
          <!-- Code pane -->
          <div id="code-pane" class="flex flex-1 min-h-0">
            <div id="editor" class="w-full h-full"></div>
          </div>

          <!-- Resource pane -->
          <div id="res-pane" class="hidden flex-1 min-h-0">
            <iframe
              id="pyxel-editor-iframe"
              class="border-0 w-full h-full"
              style="background-color: var(--pyxel-background-color)"
              title="Pyxel Resource Editor"
            ></iframe>
          </div>
        </div>

        <!-- Divider: draggable vertical bar (thicker, no gap) -->
        <div
          id="divider-hit"
          class="z-50 relative w-2.5 cursor-col-resize select-none"
          style="
            background-color: #000000;
            touch-action: none;
            pointer-events: none;
          "
          onpointerenter="this.style.backgroundColor='#3a4a5f'"
          onpointerleave="this.style.backgroundColor='#232d3b'"
          title="Drag to resize"
        ></div>

        <!-- RIGHT SIDE (preview only) -->
        <div
          class="flex flex-col flex-1 min-h-0"
          style="background-color: var(--pyxel-background-color)"
        >
          <iframe
            id="pyxel-screen-iframe"
            class="flex-1 border-0 w-full h-full min-h-0"
            style="background-color: var(--pyxel-background-color)"
            title="Pyxel Runtime"
          ></iframe>
        </div>
      </div>
    </div>

    <input
      id="load-file-input"
      type="file"
      accept=".zip,application/zip"
      class="hidden"
    />
    <input
      id="import-file-input"
      type="file"
      accept=".zip,application/zip"
      class="hidden"
    />

    <script>
      // -------------------------------------------------
      // Utility functions
      // -------------------------------------------------
      function uint8ToBase64(u8) {
        let bin = "";
        for (let i = 0; i < u8.length; i++) {
          bin += String.fromCharCode(u8[i]);
        }
        return btoa(bin);
      }

      function base64ToUint8(b64) {
        const bin = atob(b64 || "");
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) {
          bytes[i] = bin.charCodeAt(i);
        }
        return bytes;
      }

      function animateRunButton(btn, ms = 150) {
        btn.classList.add("active");
        setTimeout(() => btn.classList.remove("active"), ms);
      }

      function resolvePyxelInput() {
        if (pyxelScreenIframe?.contentWindow?.pyxelContext?.resolveInput) {
          pyxelScreenIframe.contentWindow.pyxelContext.resolveInput();
        }

        if (pyxelEditorIframe?.contentWindow?.pyxelContext?.resolveInput) {
          pyxelEditorIframe.contentWindow.pyxelContext.resolveInput();
        }
      }

      window.addEventListener("click", () => {
        resolvePyxelInput();
      });

      window.addEventListener("touchstart", () => {
        resolvePyxelInput();
      });

      window.addEventListener("keydown", (e) => {
        resolvePyxelInput();
      });

      // -------------------------------------------------
      // Ace Editor setup
      // -------------------------------------------------
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/python");

      editor.renderer.setScrollMargin(8, 0, 0, 0);
      editor.renderer.setPadding(8);

      editor.setOptions({
        fontSize: "14px",
        showPrintMargin: false,
        highlightActiveLine: true,
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
        enableSnippets: true,
      });

      editor.container.style.backgroundColor = "#111827";

      const gutter = editor.renderer.$gutter;
      if (gutter?.style) {
        gutter.style.background = "#232d3b";
      }

      const aceThemeStyle = document.createElement("style");
      aceThemeStyle.textContent = `
        .ace-monokai .ace_marker-layer .ace_active-line,
        .ace_monokai .ace_marker-layer .ace_active-line {
          background-color: #232d3b !important;
        }

        .ace-monokai .ace_gutter-active-line,
        .ace_monokai .ace_gutter-active-line {
          background-color: #374151 !important;
        }
      `;
      document.head.appendChild(aceThemeStyle);

      // -------------------------------------------------
      // Completions
      // -------------------------------------------------
      let completions = [];

      fetch("completions.txt")
        .then((res) => res.text())
        .then((text) => {
          completions = text
            .trim()
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line && !line.startsWith("#"));
        });

      const pyxelCompleter = {
        getCompletions(editor, session, pos, prefix, callback) {
          callback(
            null,
            completions.map((w) => ({ caption: w, value: w, meta: "pyxel" }))
          );
        },
      };
      ace.require("ace/ext/language_tools").addCompleter(pyxelCompleter);

      // -------------------------------------------------
      // DOM elements
      // -------------------------------------------------
      const codePane = document.getElementById("code-pane");
      const resPane = document.getElementById("res-pane");
      const codeTabBtn = document.getElementById("code-tab-btn");
      const resTabBtn = document.getElementById("res-tab-btn");

      const pyxelScreenIframe = document.getElementById("pyxel-screen-iframe");
      const pyxelEditorIframe = document.getElementById("pyxel-editor-iframe");

      const loadFileInput = document.getElementById("load-file-input");
      const importFileInput = document.getElementById("import-file-input");

      // 現在のプロジェクトのファイルハンドル / 名前を保持
      let currentProjectFileHandle = null;
      let currentProjectFileName = "pyxel-project.zip";

      // project 等の初期化（未定義エラー対策）
      let resPath = null;

      // iframe 初期化状態を管理（起動直後に import/export が動いても安全にする）
      let iframesReady = false;
      let pendingImported = false;

      // -------------------------------------------------
      // Split resize (drag center divider)
      // -------------------------------------------------
      const mainSplit = document.getElementById("main-split");
      const leftPaneEl = document.getElementById("left-pane");
      const dividerHitEl = document.getElementById("divider-hit");

      let dragging = false;
      let startX = 0;
      let startWidth = 0;

      function onMove(e) {
        if (!dragging) return;
        const dx = e.clientX - startX;
        let newW = startWidth + dx;

        const containerW = mainSplit.getBoundingClientRect().width;
        const minAllowedWidth = Math.min(200, containerW / 2);
        const maxW = containerW - minAllowedWidth;

        if (newW < minAllowedWidth) newW = minAllowedWidth;
        if (newW > maxW) newW = maxW;

        leftPaneEl.style.width = newW + "px";
        editor.resize();
      }

      function onUp() {
        if (!dragging) return;
        dragging = false;
        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", onUp);
        window.removeEventListener("pointercancel", onUp);

        document.body.style.cursor = "";
        document.body.style.userSelect = "";
        // Show the right-side iframes again after dragging ends
        if (pyxelScreenIframe) pyxelScreenIframe.style.display = "";
        if (pyxelEditorIframe) pyxelEditorIframe.style.display = "";
      }

      dividerHitEl.addEventListener("pointerdown", (e) => {
        dragging = true;
        startX = e.clientX;
        startWidth = leftPaneEl.getBoundingClientRect().width;

        document.body.style.cursor = "col-resize";
        document.body.style.userSelect = "none";
        // Hide the right-side iframes while dragging to prevent flickering
        if (pyxelScreenIframe) pyxelScreenIframe.style.display = "none";
        if (pyxelEditorIframe) pyxelEditorIframe.style.display = "none";

        window.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", onUp);
        window.addEventListener("pointercancel", onUp);

        e.preventDefault();
      });

      // -------------------------------------------------
      // Pane switching functions
      // -------------------------------------------------
      function switchPane(pane) {
        if (pane === "code") {
          codePane.classList.remove("hidden");
          resPane.classList.add("hidden");

          codeTabBtn.classList.add("seg-active");
          resTabBtn.classList.remove("seg-active");
          codeTabBtn.setAttribute("aria-pressed", "true");
          resTabBtn.setAttribute("aria-pressed", "false");

          leftPaneEl.classList.remove("res-mode");
          setTimeout(() => editor.resize(), 0);
        } else if (pane === "res") {
          codePane.classList.add("hidden");
          resPane.classList.remove("hidden");

          codeTabBtn.classList.remove("seg-active");
          resTabBtn.classList.add("seg-active");
          codeTabBtn.setAttribute("aria-pressed", "false");
          resTabBtn.setAttribute("aria-pressed", "true");
          leftPaneEl.classList.add("res-mode");
        }
      }

      async function resetPyxelScreen() {
        const ctrlDown = new KeyboardEvent("keydown", {
          key: "Control",
          code: "ControlLeft",
          ctrlKey: true,
          bubbles: true,
        });
        pyxelEditorIframe.contentWindow.document.dispatchEvent(ctrlDown);

        const sDown = new KeyboardEvent("keydown", {
          key: "s",
          code: "KeyS",
          ctrlKey: true,
          bubbles: true,
        });
        pyxelEditorIframe.contentWindow.document.dispatchEvent(sDown);

        const sUp = new KeyboardEvent("keyup", {
          key: "s",
          code: "KeyS",
          ctrlKey: true,
          bubbles: true,
        });
        pyxelEditorIframe.contentWindow.document.dispatchEvent(sUp);

        const ctrlUp = new KeyboardEvent("keyup", {
          key: "Control",
          code: "ControlLeft",
          ctrlKey: false,
          bubbles: true,
        });
        pyxelEditorIframe.contentWindow.document.dispatchEvent(ctrlUp);

        setTimeout(() => {
          window.code = editor.getValue();
          window.res = uint8ToBase64(
            pyxelEditorIframe.contentWindow.pyxelContext.pyodide.FS.readFile(
              PYXEL_WORKING_DIRECTORY + "/my_resource.pyxres"
            )
          );

          pyxelScreenIframe.contentWindow.resetPyxel();
        }, 100);
      }

      // -------------------------------------------------
      // Project operations
      // -------------------------------------------------
      async function importProject(file) {
        if (!file) return;
        try {
          // 解析して window.code / window.res に反映するだけ
          resPath = null;
          const buf = await file.arrayBuffer();
          const zip = await JSZip.loadAsync(buf);

          let pyCode = null;
          let foundResName = null;
          let foundResB64 = null;

          const entries = Object.entries(zip.files);
          for (const [path, entry] of entries) {
            if (entry.dir) continue;
            if (path.endsWith("main.py")) {
              pyCode = await entry.async("string");
            } else if (path.toLowerCase().endsWith(".pyxres") && !foundResB64) {
              const u8 = await entry.async("uint8array");
              foundResB64 = uint8ToBase64(u8);
              foundResName = path;
            }
          }

          if (pyCode == null) {
            throw new Error("main.py not found in zip file");
          }

          window.code = pyCode;
          editor.setValue(pyCode, -1);
          editor.focus();

          if (foundResB64) {
            resPath = foundResName;
            window.res = foundResB64;
          }

          // 既存のフック／更新処理を呼ぶ（定義済みの関数がある前提）
          if (typeof window.onImportedProject === "function") {
            window.onImportedProject();
          } else if (iframesReady && typeof resetPyxelScreen === "function") {
            // iframe が準備できていれば即時実行
            resetPyxelScreen();
          } else {
            // iframe 未準備なら画面切替のみ行い、準備完了時に reset を実行する
            switchPane("code");
            pendingImported = true;
          }
        } catch (e) {
          console.warn("Failed to load zip:", e);
          alert("Failed to import project: " + e.message);
        }
      }

      async function exportProject() {
        //await saveCurrentToMemory();

        const zip = new JSZip();

        // main.py は window.code、リソースは window.res を使う
        if (typeof window.code === "string") {
          zip.file("main.py", window.code);
        }
        if (resPath && typeof window.res === "string") {
          const bytes = base64ToUint8(window.res);
          // resPath があればその名前で、なければデフォルト名で保存
          const resName = resPath.split("/").pop() || "my_resource.pyxres";
          zip.file(resName, bytes);
        }

        const blob = await zip.generateAsync({ type: "blob" });

        // showSaveFilePicker が使えるなら、毎回保存ダイアログを出す（既存 handle に自動上書きはしない）
        if (window.showSaveFilePicker) {
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: currentProjectFileName,
              types: [
                {
                  description: "ZIP",
                  accept: { "application/zip": [".zip"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            // 保存先ハンドルと名前は更新しておく（次回の suggestedName に使う）
            currentProjectFileHandle = handle;
            currentProjectFileName = handle.name || currentProjectFileName;
            return;
          } catch (e) {
            if (e.name === "AbortError") return;
            console.warn("save failed:", e);
          }
        }

        // 3) フォールバック：従来のダウンロードリンク方式
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = currentProjectFileName || "pyxel-project.zip";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }

      // -------------------------------------------------
      // Event listeners registration
      // -------------------------------------------------
      codeTabBtn.addEventListener("click", () => {
        switchPane("code");
      });

      resTabBtn.addEventListener("click", () => {
        switchPane("res");
      });

      document
        .getElementById("importBtn")
        ?.addEventListener("click", async () => {
          animateRunButton(document.getElementById("importBtn"));

          // 可能なら File System Access API でファイル選択（handle を取得）
          if (window.showOpenFilePicker) {
            try {
              const [handle] = await window.showOpenFilePicker({
                multiple: false,
                types: [
                  {
                    description: "ZIP",
                    accept: { "application/zip": [".zip"] },
                  },
                ],
              });
              const file = await handle.getFile();
              currentProjectFileHandle = handle;
              currentProjectFileName = file.name || currentProjectFileName;
              await importProject(file);
              return;
            } catch (e) {
              // ユーザーがキャンセルした場合は何もしない（下の input フォールバックに進む）
              if (e.name === "AbortError") return;
            }
          }

          // フォールバック：従来の file input を開く
          importFileInput.value = "";
          importFileInput.click();
        });

      importFileInput.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        // input からの取り込みではハンドルは取得できないため null にし、名前だけ保存
        currentProjectFileHandle = null;
        if (file && file.name) currentProjectFileName = file.name;
        await importProject(file);
      });

      document.getElementById("exportBtn")?.addEventListener("click", () => {
        animateRunButton(document.getElementById("exportBtn"));
        exportProject();
      });

      const runBtn = document.getElementById("runBtn");
      runBtn?.addEventListener("click", () => {
        animateRunButton(runBtn);
        resetPyxelScreen();
      });

      // -------------------------------------------------
      // DOMContentLoaded: アプリ初期化を開始
      // -------------------------------------------------
      async function loadInitialFiles() {
        window.code = await (await fetch("main.py")).text();
        window.res = uint8ToBase64(
          new Uint8Array(
            await (await fetch("my_resource.pyxres")).arrayBuffer()
          )
        );

        editor.setValue(window.code, -1);
        editor.focus();

        // 初期リソース名を保持しておく
        if (window.res) {
          resPath = "my_resource.pyxres";
        }
      }

      function initializeIframes() {
        return new Promise((resolve) => {
          let pyxelScreenLoaded = false;
          let pyxelEditorLoaded = false;
          // resolve が呼ばれたタイミングで iframesReady をセットする
          const maybeResolve = () => {
            if (pyxelScreenLoaded && pyxelEditorLoaded) {
              iframesReady = true;
              // もし import が先行していたらここで実行する
              if (pendingImported) {
                pendingImported = false;
                if (typeof resetPyxelScreen === "function") {
                  try {
                    resetPyxelScreen();
                  } catch (e) {
                    console.warn(
                      "resetPyxelScreen failed after iframe ready:",
                      e
                    );
                  }
                }
              }
              resolve();
            }
          };

          pyxelScreenIframe.onload = () => {
            pyxelScreenLoaded = true;
            maybeResolve();
          };

          pyxelEditorIframe.onload = () => {
            pyxelEditorLoaded = true;
            maybeResolve();
          };

          pyxelScreenIframe.src = "pyxel-screen.html";
          pyxelEditorIframe.src = "pyxel-editor.html";
        });
      }

      function watchPyxelInputWait() {
        if (
          pyxelScreenIframe?.contentWindow?.pyxelContext?.resolveInput &&
          pyxelEditorIframe?.contentWindow?.pyxelContext?.resolveInput
        ) {
          const runBtn = document.getElementById("runBtn");
          if (runBtn) {
            runBtn.disabled = false;
          }
          const resTabBtn = document.getElementById("res-tab-btn");
          if (resTabBtn) {
            resTabBtn.disabled = false;
            resTabBtn.classList.remove("disabled");
          }
          // Enable divider interactions when run button is active
          dividerHitEl.style.pointerEvents = "auto";
          dividerHitEl.style.backgroundColor = "#232d3b";
        } else {
          setTimeout(watchPyxelInputWait, 100);
        }
      }

      window.addEventListener("DOMContentLoaded", async () => {
        switchPane("code");
        await loadInitialFiles();
        await initializeIframes();
        watchPyxelInputWait();
      });
    </script>
  </body>
</html>
