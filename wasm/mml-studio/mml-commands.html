<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../docs/images/pyxel_icon_64x64.ico" />
    <title>Pyxel MML Commands</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <style type="text/tailwindcss">
      @layer components {
        .page {
          @apply bg-gray-900 h-full text-gray-100 antialiased;
        }
        .container {
          @apply mx-auto p-6 max-w-3xl;
        }
        .heading {
          @apply font-semibold text-2xl tracking-tight;
        }
        .subheading {
          @apply text-gray-300 text-sm;
        }
        .link {
          @apply outline-none focus-visible:ring-1 focus-visible:ring-indigo-300 text-indigo-400 hover:text-indigo-300 underline underline-offset-2 rounded-sm;
        }
        .mono {
          @apply font-mono text-sm;
        }
        .card {
          @apply bg-gray-800 shadow-sm px-2 sm:px-3 py-1 sm:py-2 border border-gray-700 rounded-2xl;
        }
        .rowcard {
          @apply mb-2 sm:mb-0;
        }
        .lang-select {
          @apply bg-gray-800 px-2 py-1 border border-gray-600 focus-visible:border-indigo-300 rounded-lg outline-none text-gray-200 text-sm;
        }
        .th {
          @apply px-3 pt-1 pb-3 border-gray-700 border-b font-semibold text-sm text-left;
        }
        .td {
          @apply px-3 py-2 border-gray-800 border-b text-sm align-top;
        }
        .stack thead {
          @apply hidden sm:table-header-group;
        }
        .stack tbody tr {
          @apply block sm:table-row;
        }
        .stack tbody td {
          @apply block sm:table-cell;
        }
        .stack tbody tr:first-child td {
          @apply pt-2 sm:pt-4;
        }
        .example {
          @apply bg-gray-900 mt-2 p-2 border border-gray-700 rounded-lg whitespace-pre mono;
        }
      }
    </style>
  </head>
  <body class="h-full page">
    <div class="container">
      <div
        class="flex sm:flex-row flex-col justify-between items-start sm:items-center gap-2 mb-2"
      >
        <h1 id="page-title" class="heading">Pyxel MML Commands</h1>
        <select id="lang-select" class="lang-select self-start sm:self-auto mt-2 sm:mt-0" style="display: none"></select>
      </div>
      <p id="subtitle" class="mb-4 subheading">
        MML command list for
        <a href="https://github.com/kitao/pyxel" target="_blank" rel="noopener noreferrer" class="link">Pyxel</a>, a retro game engine for Python.
      </p>

      <div class="overflow-x-auto card">
        <table class="w-full border-collapse stack">
          <thead>
            <tr>
              <th id="th-command" class="th">Command</th>
              <th id="th-description" class="th">Description</th>
            </tr>
          </thead>
          <tbody id="command-table"></tbody>
        </table>
      </div>
    </div>

    <script>
      let data = null;
      let currentLang = "en";

      function t(key) {
        const obj = data?.ui[key];
        if (!obj) return key;
        return obj[currentLang] || obj["en"] || "";
      }

      function extLink(href, text) {
        return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="link">${text}</a>`;
      }

      function detectLanguage() {
        const stored = localStorage.getItem("pyxel-showcase-lang");
        if (stored && data.languages.some((l) => l.code === stored)) {
          return stored;
        }
        const nav = navigator.language || "";
        const navLower = nav.toLowerCase();
        if (navLower.startsWith("zh")) return "cn";
        for (const lang of data.languages) {
          if (navLower.startsWith(lang.code)) return lang.code;
        }
        return "en";
      }

      function render() {
        // Title and subtitle
        document.getElementById("page-title").textContent = t("title");
        document.getElementById("subtitle").innerHTML = t("subtitle")
          .replace("{0}", extLink("https://github.com/kitao/pyxel", "Pyxel"));

        // Table headers
        document.getElementById("th-command").textContent = t("th_command");
        document.getElementById("th-description").textContent = t("th_description");

        // Commands
        const commandTable = document.getElementById("command-table");
        commandTable.innerHTML = "";
        const thCmd = t("th_command");
        const thDesc = t("th_description");

        for (const c of data.commands) {
          let cmdHTML = c.cmd
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;");

          if (c.cmd.startsWith("C/D/E/F/G/A/B")) {
            cmdHTML = cmdHTML.replaceAll("/", "/<wbr>");
          }

          const descText = (c.desc[currentLang] || c.desc["en"] || "")
            .replace(/`([^`]+)`/g, "<code>$1</code>")
            .replaceAll("\\n", "<br>");

          const tr = document.createElement("tr");
          tr.className = "rowcard";
          tr.innerHTML = `
            <td class="w-full sm:w-40 max-w-none break-words whitespace-normal td mono shrink-0">
              <span class="sm:hidden font-medium text-gray-500 text-xs">${thCmd}</span>
              <div>${cmdHTML}</div>
            </td>
            <td class="td">
              <span class="sm:hidden font-medium text-gray-500 text-xs">${thDesc}</span>
              <div>${descText}</div>
              ${c.example ? `<div class="example">${c.example}</div>` : ""}
            </td>
          `;
          commandTable.appendChild(tr);
        }

        document.documentElement.lang = currentLang === "cn" ? "zh" : currentLang;
      }

      // Init i18n
      fetch("mml-commands.json")
        .then((r) => r.json())
        .then((json) => {
          data = json;
          currentLang = detectLanguage();

          // Build language selector
          const langSelect = document.getElementById("lang-select");
          for (const lang of data.languages) {
            const opt = document.createElement("option");
            opt.value = lang.code;
            opt.textContent = lang.name;
            langSelect.appendChild(opt);
          }
          langSelect.value = currentLang;
          langSelect.addEventListener("change", () => {
            currentLang = langSelect.value;
            localStorage.setItem("pyxel-showcase-lang", currentLang);
            render();
          });
          langSelect.style.display = "";

          render();
        });
    </script>
  </body>
</html>
