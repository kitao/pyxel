name: build

on: [workflow_call, workflow_dispatch]

env:
  PYTHON_VERSION: "3.14"
  SDL2_VERSION: "2.32.10"

jobs:
  build-winmac:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            arch: x64

          - target: i686-pc-windows-msvc
            os: windows-2022
            arch: x86

          - target: x86_64-apple-darwin
            os: macos-15-intel
            arch: x64
            min_macos: "10.13"

          - target: aarch64-apple-darwin
            os: macos-15
            arch: arm64
            min_macos: "11.0"

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - &resolve-rust-version
        name: Resolve Rust version
        shell: bash
        run: |
          RUST_VERSION="$(awk -F'"' '/^channel = / { print $2; exit }' rust-toolchain.toml)"
          test -n "$RUST_VERSION"
          echo "RUST_VERSION=$RUST_VERSION" >> "$GITHUB_ENV"

      - &install-rust
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rust-src, rustfmt, clippy

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}

      - &install-build-deps
        name: Install build dependencies
        run: pip install -r python/requirements.txt

      - name: Build wheel
        shell: bash
        run: |
          export MACOSX_DEPLOYMENT_TARGET=${{ matrix.min_macos }}
          make TARGET=${{ matrix.target }}

      - &upload-wheel
        name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: pyxel-${{ matrix.target }}
          path: dist/*

  build-linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            image: messense/manylinux2014-cross:x86_64

          - target: i686-unknown-linux-gnu
            image: messense/manylinux2014-cross:i686

          - target: aarch64-unknown-linux-gnu
            image: messense/manylinux2014-cross:aarch64

          - target: armv7-unknown-linux-gnueabihf
            image: messense/manylinux2014-cross:armv7l

    runs-on: ubuntu-22.04
    container: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v4

      - *resolve-rust-version
      - *install-rust

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - *install-build-deps

      - name: Install SDL2 build dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq --no-install-recommends \
            cmake pkg-config \
            libx11-dev libxext-dev libxcursor-dev libxi-dev \
            libxrandr-dev libxfixes-dev libxss-dev libxcb1-dev \
            libwayland-dev libxkbcommon-dev libdecor-0-dev \
            libegl-dev libgl-dev libgles-dev \
            libasound2-dev libpulse-dev \
            libdbus-1-dev

      - name: Copy headers to cross-compilation sysroot
        run: |
          SYSROOT=/usr/${{ matrix.target }}/${{ matrix.target }}/sysroot

          # X11/XCB headers: use sysroot's existing ones (compatible with cross-compiler)
          # Only copy if missing
          [ ! -d "$SYSROOT/usr/include/X11" ] && cp -r /usr/include/X11 $SYSROOT/usr/include/
          [ ! -d "$SYSROOT/usr/include/xcb" ] && [ -d /usr/include/xcb ] && cp -r /usr/include/xcb $SYSROOT/usr/include/

          # Wayland
          cp /usr/include/wayland-*.h $SYSROOT/usr/include/

          # xkbcommon
          cp -r /usr/include/xkbcommon $SYSROOT/usr/include/

          # libdecor
          cp -r /usr/include/libdecor-0 $SYSROOT/usr/include/

          # OpenGL/EGL/GLES (required for Wayland driver detection)
          for dir in EGL GL GLES GLES2 GLES3 KHR; do
            [ -d "/usr/include/$dir" ] && cp -r /usr/include/$dir $SYSROOT/usr/include/
          done

          # ALSA
          cp -r /usr/include/alsa $SYSROOT/usr/include/

          # PulseAudio
          cp -r /usr/include/pulse $SYSROOT/usr/include/

          # D-Bus (including arch-specific dbus-arch-deps.h)
          cp -r /usr/include/dbus-1.0 $SYSROOT/usr/include/
          DBUS_ARCH_DIR=$(find /usr/lib -path "*/dbus-1.0/include" -type d 2>/dev/null | head -1)
          if [ -n "$DBUS_ARCH_DIR" ]; then
            cp "$DBUS_ARCH_DIR/dbus/dbus-arch-deps.h" $SYSROOT/usr/include/dbus-1.0/dbus/
          fi

          # Copy ALL pkg-config .pc files
          mkdir -p $SYSROOT/usr/lib/pkgconfig
          cp /usr/lib/x86_64-linux-gnu/pkgconfig/*.pc $SYSROOT/usr/lib/pkgconfig/ 2>/dev/null || true
          cp /usr/share/pkgconfig/*.pc $SYSROOT/usr/lib/pkgconfig/ 2>/dev/null || true

          # Create library stubs for cmake FindLibraryAndSONAME()
          # With SDL_*_SHARED=ON, these are NOT linked against.
          # They only exist so cmake can resolve SONAMEs for dlopen.
          mkdir -p $SYSROOT/usr/lib
          stub_lib() {
            touch "$SYSROOT/usr/lib/lib${1}.so.${2}"
            ln -sf "lib${1}.so.${2}" "$SYSROOT/usr/lib/lib${1}.so"
          }
          stub_lib X11 6
          stub_lib Xext 6
          stub_lib Xcursor 1
          stub_lib Xi 6
          stub_lib Xrandr 2
          stub_lib Xfixes 3
          stub_lib Xss 1
          stub_lib asound 2

      - name: Build SDL2
        run: |
          SYSROOT=/usr/${{ matrix.target }}/${{ matrix.target }}/sysroot
          PREFIX=/usr/${{ matrix.target }}

          curl -sqLO https://www.libsdl.org/release/SDL2-${{ env.SDL2_VERSION }}.tar.gz
          tar xzf SDL2-${{ env.SDL2_VERSION }}.tar.gz

          # Patch: remove XGenericEventCookie forward declaration that conflicts
          # with Xlib.h when using GCC 4.8 (manylinux2014 cross-compiler)
          sed -i '/#ifndef SDL_VIDEO_DRIVER_X11_SUPPORTS_GENERIC_EVENTS/,/#endif/d' \
            SDL2-${{ env.SDL2_VERSION }}/src/video/x11/SDL_x11xinput2.h

          # Create cmake toolchain file for cross-compilation
          TARGET_CXX=$(echo "$TARGET_CC" | sed 's/gcc/g++/')
          TOOLCHAIN=/tmp/toolchain.cmake
          echo "set(CMAKE_SYSTEM_NAME Linux)" > "$TOOLCHAIN"
          echo "set(CMAKE_C_COMPILER $TARGET_CC)" >> "$TOOLCHAIN"
          echo "set(CMAKE_CXX_COMPILER $TARGET_CXX)" >> "$TOOLCHAIN"
          echo "set(CMAKE_AR $TARGET_AR CACHE FILEPATH Archiver)" >> "$TOOLCHAIN"
          echo "set(CMAKE_RANLIB $TARGET_RANLIB CACHE FILEPATH Ranlib)" >> "$TOOLCHAIN"
          echo "set(CMAKE_FIND_ROOT_PATH $SYSROOT)" >> "$TOOLCHAIN"
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> "$TOOLCHAIN"
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> "$TOOLCHAIN"
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> "$TOOLCHAIN"
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)" >> "$TOOLCHAIN"

          export PKG_CONFIG_LIBDIR="$SYSROOT/usr/lib/pkgconfig"
          export PKG_CONFIG_PATH=""

          cmake -S SDL2-${{ env.SDL2_VERSION }} -B sdl2-build \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$PREFIX" \
            -DCMAKE_C_FLAGS="-fPIC -I$SYSROOT/usr/include -I$SYSROOT/usr/include/dbus-1.0" \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DSDL_SHARED=ON \
            -DSDL_STATIC=ON \
            -DSDL_DLOPEN=ON \
            -DSDL_X11=ON -DSDL_X11_SHARED=ON \
            -DSDL_WAYLAND=ON -DSDL_WAYLAND_SHARED=ON \
            -DSDL_WAYLAND_LIBDECOR=ON -DSDL_WAYLAND_LIBDECOR_SHARED=ON \
            -DSDL_OPENGL=ON \
            -DSDL_OPENGLES=ON \
            -DSDL_ALSA=ON -DSDL_ALSA_SHARED=ON \
            -DSDL_PULSEAUDIO=ON -DSDL_PULSEAUDIO_SHARED=ON \
            -DSDL_VULKAN=OFF \
            -DSDL_DBUS=ON \
            -DSDL_IBUS=ON \
            -DSDL_IME=ON \
            -DWAYLAND_SCANNER=/usr/bin/wayland-scanner

          cmake --build sdl2-build -j$(nproc)
          cmake --install sdl2-build

          # Verify expected drivers are present
          echo "=== Verifying built SDL2 ==="
          FAIL=0
          for pattern in libX11 libwayland-client libasound libpulse; do
            if strings "$PREFIX/lib/libSDL2.so" | grep -q "$pattern"; then
              echo "PASS: $pattern found"
            else
              echo "FAIL: $pattern NOT found"
              FAIL=1
            fi
          done
          [ $FAIL -eq 0 ] || exit 1

          rm -rf SDL2-${{ env.SDL2_VERSION }} sdl2-build

      - name: Build wheel
        run: |
          export BINDGENFLAGS="-I/usr/${{ matrix.target }}/include/SDL2 -I/usr/${{ matrix.target }}/${{ matrix.target }}/sysroot/usr/include"
          export RUSTFLAGS="-L/usr/${{ matrix.target }}/lib"
          export LD_LIBRARY_PATH="/usr/${{ matrix.target }}/lib:${LD_LIBRARY_PATH:-}"

          make TARGET=${{ matrix.target }}

      - *upload-wheel

  verify:
    needs: [build-winmac, build-linux]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-2022

          - target: x86_64-apple-darwin
            os: macos-15-intel

          - target: aarch64-apple-darwin
            os: macos-15

          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04

    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: pyxel-${{ matrix.target }}
          path: dist

      - name: List wheel contents
        shell: bash
        run: |
          unzip -l dist/*.whl | grep -iE '\.so|\.dll|\.dylib|sdl' || echo "No shared libraries found"

      - name: Verify import
        shell: bash
        run: |
          pip install dist/*.whl
          python -c "import pyxel; print(f'Pyxel {pyxel.VERSION} imported successfully')"

      - name: Verify SDL2 drivers (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          PYXEL_DIR=$(python -c "import pyxel, os; print(os.path.dirname(pyxel.__file__))")
          SDL2_LIB=$(find "$PYXEL_DIR" -name "libSDL2*" -name "*.so*" 2>/dev/null | head -1)

          if [ -z "$SDL2_LIB" ]; then
            # Also check pyxel.libs/ directory
            SDL2_LIB=$(find "$(dirname "$PYXEL_DIR")" -path "*/pyxel.libs/libSDL2*" -name "*.so*" 2>/dev/null | head -1)
          fi

          if [ -z "$SDL2_LIB" ]; then
            echo "FAIL: Could not find bundled SDL2 library"
            exit 1
          fi

          echo "Found SDL2 library: $SDL2_LIB"
          FAIL=0
          for pattern in libX11.so libwayland-client.so libasound.so libpulse.so; do
            if strings "$SDL2_LIB" | grep -q "$pattern"; then
              echo "PASS: $pattern dlopen target found"
            else
              echo "FAIL: $pattern dlopen target NOT found"
              FAIL=1
            fi
          done
          [ $FAIL -eq 0 ] || exit 1
