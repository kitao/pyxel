#!/usr/bin/env python3

import pathlib
import sys
import zipfile

ROOT_DIR = pathlib.Path(__file__).resolve().parent.parent
DIST_DIR = ROOT_DIR / "dist"

WHEEL_GLOB = "*-emscripten_*.whl"
TARGET_SUFFIXES = (".so", ".wasm", ".js")

HOST_PATH_PATTERNS = (
    b"/Users/",
    b"/home/",
    b"/private/",
    b"\\Users\\",
    b"\\home\\",
)


def find_wheels():
    wheels = sorted(DIST_DIR.glob(WHEEL_GLOB))
    if not wheels:
        print(f"no wasm wheel found in {DIST_DIR}")
        sys.exit(1)
    return wheels


def find_violations(wheel_path):
    violations = []
    with zipfile.ZipFile(wheel_path) as wheel_zip:
        for name in wheel_zip.namelist():
            if not name.endswith(TARGET_SUFFIXES):
                continue

            data = wheel_zip.read(name)
            for pattern in HOST_PATH_PATTERNS:
                if pattern in data:
                    violations.append((name, pattern))
                    break
    return violations


def main() -> int:
    wheels = find_wheels()
    has_error = False

    for wheel_path in wheels:
        violations = find_violations(wheel_path)
        if not violations:
            print(f"ok: {wheel_path.name}")
            continue

        has_error = True
        print(f"error: host path detected in {wheel_path.name}")
        for entry, pattern in violations:
            print(f"  - {entry}: matched {pattern!r}")

    return 1 if has_error else 0


if __name__ == "__main__":
    sys.exit(main())
