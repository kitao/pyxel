#!/usr/bin/env python3

import pathlib
import re
import sys

ROOT_DIR = pathlib.Path(__file__).resolve().parent.parent
PYTHON_VERSION_REPLACEMENTS = (
    ("crates/pyxel-core/src/settings.rs", '(VERSION.*)".*"'),
    ("python/pyproject.toml", '(version.*)".*"'),
)
CARGO_VERSION_REPLACEMENTS = (
    ("crates/pyxel-core/Cargo.toml", '(version.*)".*"'),
    ("crates/pyxel-binding/Cargo.toml", '(version.*)".*"'),
    ("crates/pyxel-binding/Cargo.toml", '(pyxel-core", version.*)".*"'),
)
PRE_RELEASE_MAP = {"a": "alpha", "b": "beta", "rc": "rc"}


def pep440_to_semver(version: str) -> str:
    m = re.match(r"^(\d+\.\d+\.\d+)(a|b|rc)(\d+)$", version)
    if m:
        base, tag, num = m.groups()
        return f"{base}-{PRE_RELEASE_MAP[tag]}.{num}"
    return version


def replace_file(path: pathlib.Path, pattern: str, repl: str) -> None:
    with path.open("r", encoding="utf-8") as f:
        code = f.read()
    code = re.sub(pattern, repl, code, count=1)
    with path.open("w", encoding="utf-8") as f:
        f.write(code)


def update_version() -> None:
    if len(sys.argv) != 2:
        print("update_version version")
        sys.exit(1)

    version = sys.argv[1]
    cargo_version = pep440_to_semver(version)

    for relative_path, pattern in PYTHON_VERSION_REPLACEMENTS:
        replace_file(ROOT_DIR / relative_path, pattern, f'\\1"{version}"')
    for relative_path, pattern in CARGO_VERSION_REPLACEMENTS:
        replace_file(ROOT_DIR / relative_path, pattern, f'\\1"{cargo_version}"')


if __name__ == "__main__":
    update_version()
